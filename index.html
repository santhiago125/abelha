<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Beeblom: Ecossistema de Simula√ß√£o (V14 - Evento Rainha)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Base de Estiliza√ß√£o */
        .ecossistema {
            width: 100%;
            height: 60vh;
            background-color: #e0f2f1; /* Tom suave de azul/verde para o c√©u */
            position: relative;
            overflow: hidden;
            border-radius: 1rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            border: 2px dashed #b9d7ea;
        }

        /* Colmeias */
        .colmeia {
            position: absolute;
            width: 150px;
            height: 100px;
            background-color: #ffc107; /* Amarelo da colmeia */
            border-radius: 0 0 75px 75px;
            border: 5px solid #ff9800;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: #333;
            font-weight: bold;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            z-index: 10;
        }
        #colmeia1 { top: 10%; left: 5%; }
        #colmeia2 { bottom: 10%; right: 5%; }
        .rainha-status {
            font-size: 1.5rem;
            margin-top: 5px;
        }

        /* Abelhas */
        .abelha {
            position: absolute;
            width: 20px;
            height: 20px;
            background-color: #ffeb3b; /* Amarelo da abelha */
            border-radius: 50%;
            border: 2px solid #000;
            z-index: 20;
            transition: opacity 0.3s ease-in-out; 
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        /* Efeito de sumir ao entrar na colmeia */
        .abelha.entering-hive {
            opacity: 0;
        }

        /* Efeito de listras pretas (simula√ß√£o) */
        .abelha::before {
            content: '';
            position: absolute;
            width: 100%;
            height: 50%;
            top: 25%;
            left: 0;
            background: repeating-linear-gradient(
                45deg,
                black,
                black 3px,
                transparent 3px,
                transparent 6px
            );
            border-radius: 50%;
        }
        .abelha.com-nectar {
            box-shadow: 0 0 10px 3px #e91e63; /* Cor-de-rosa para n√©ctar */
        }
        .abelha:hover {
            transform: scale(1.3);
        }

        /* Flores */
        .flor {
            position: absolute;
            width: 30px;
            height: 30px;
            background-color: #f44336; /* Flor vermelha */
            border-radius: 50%;
            border: 2px solid #880e4f;
            display: flex;
            flex-direction: column; /* Para empilhar o valor e o tooltip */
            justify-content: center;
            align-items: center;
            
            /* Ajuste de Texto Padr√£o: Mais escuro e leg√≠vel */
            color: #333; 
            font-size: 10px;
            font-weight: bold;
            cursor: pointer;
            z-index: 15;
            transition: background-color 0.5s, box-shadow 0.5s;
        }
        
        /* Tooltip de Detalhes da Flor */
        .flor-tooltip {
            position: absolute;
            bottom: 110%; /* Posiciona acima da flor */
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.85); /* Fundo escuro semi-transparente */
            color: #fff; /* Texto branco */
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 10px;
            font-weight: normal;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none; /* N√£o interfere nos eventos de clique/hover */
            transition: opacity 0.2s ease;
            z-index: 30;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            text-align: center;
        }

        /* Mostrar Tooltip ao passar o mouse */
        .flor:hover .flor-tooltip {
            opacity: 1;
        }

        /* Estilo para flor esgotada (cinza) */
        .flor.sem-nectar {
            background-color: #9e9e9e; 
            border-color: #616161;
            box-shadow: none;
            color: #333;
            transition: all 0.5s ease-in-out;
            cursor: default;
        }
        
        /* Estilo para flor ocupada (borda verde ou algo que indique uso) */
        .flor.ocupada {
             border-color: #10b981; 
             box-shadow: 0 0 5px 2px #34d399;
        }

        /* Painel de Status/Tempo */
        .status-panel {
            background-color: #ffffff;
            border-radius: 0.75rem;
            padding: 1rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }
        .status-item i {
            font-size: 1.5rem;
            margin-right: 0.5rem;
        }

        /* Pop-up de Alerta de Evento */
        .event-popup-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            display: none; /* Inicia oculto */
            backdrop-filter: blur(5px);
        }
        .event-popup-content {
            background: linear-gradient(145deg, #fff 0%, #f0f4f8 100%);
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
            text-align: center;
            width: 90%;
            max-width: 500px;
            animation: fadeIn 0.3s ease-out;
            border: 4px solid #f97316; /* Cor de alerta */
        }
        .event-popup-timer {
            font-size: 3rem;
            font-weight: bold;
            color: #ef4444;
            margin: 1rem 0;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }

    </style>
</head>
<body class="bg-gray-100 min-h-screen p-4 flex flex-col items-center font-sans">

    <h1 class="text-4xl font-extrabold text-gray-800 mb-6 mt-4">Beeblom: Ecossistema de Simula√ß√£o</h1>

    <div id="statusPanel" class="status-panel w-full max-w-4xl mb-6 grid grid-cols-2 md:grid-cols-4 gap-4">
        <div class="status-item flex items-center bg-blue-50 p-3 rounded-lg border border-blue-200">
            <span id="icone-tempo">üìÖ</span>
            <div>
                <p class="text-sm font-medium text-gray-500">Dia de Jogo</p>
                <p id="diaJogo" class="text-xl font-bold text-blue-700">1</p>
            </div>
        </div>
        <div class="status-item flex items-center bg-yellow-50 p-3 rounded-lg border border-yellow-200 col-span-2 md:col-span-1">
            <span id="icone-status">‚òÄÔ∏è</span>
            <div>
                <p class="text-sm font-medium text-gray-500">Status Clim√°tico</p>
                <p id="statusEventoAtual" class="text-xl font-bold text-yellow-700">Normal</p>
            </div>
        </div>
        <div class="status-item flex items-center bg-red-50 p-3 rounded-lg border border-red-200">
            <span id="icone-impacto">‚ö°</span>
            <div>
                <p class="text-sm font-medium text-gray-500">Efeito</p>
                <p id="impactoEvento" class="text-xl font-bold text-red-700">Nenhum</p>
            </div>
        </div>
        <div class="status-item flex items-center bg-green-50 p-3 rounded-lg border border-green-200">
            <span id="icone-mel1">üçØ</span>
            <div>
                <p class="text-sm font-medium text-gray-500">Mel Colmeia 1</p>
                <p id="melColmeia1Display" class="text-xl font-bold text-green-700">0</p>
            </div>
        </div>
        <div class="status-item flex items-center bg-green-50 p-3 rounded-lg border border-green-200">
            <span id="icone-mel2">üçØ</span>
            <div>
                <p class="text-sm font-medium text-gray-500">Mel Colmeia 2</p>
                <p id="melColmeia2Display" class="text-xl font-bold text-green-700">0</p>
            </div>
        </div>
        <div class="status-item flex items-center bg-purple-50 p-3 rounded-lg border border-purple-200">
            <span id="icone-abelhas">üêù</span>
            <div>
                <p class="text-sm font-medium text-gray-500">Abelhas Vivas</p>
                <p id="totalAbelhas" class="text-xl font-bold text-purple-700">0</p>
            </div>
        </div>
        <div class="status-item flex items-center bg-pink-50 p-3 rounded-lg border border-pink-200">
            <span id="icone-flores">üå∏</span>
            <div>
                <p class="text-sm font-medium text-gray-500">Flores Ativas</p>
                <p id="totalFlores" class="text-xl font-bold text-pink-700">0</p>
            </div>
        </div>
        <div class="status-item flex items-center bg-gray-50 p-3 rounded-lg border border-gray-200">
            <span id="icone-limite">üéØ</span>
            <div>
                <p class="text-sm font-medium text-gray-500">Limite de Abelhas</p>
                <p id="maxAbelhasDisplay" class="text-xl font-bold text-gray-700">50</p>
            </div>
        </div>
    </div>

    <div id="ecossistema" class="ecossistema w-full max-w-4xl">
        <div id="colmeia1" class="colmeia">
            Colmeia 1
            <span class="mel-produzido">Mel: 0</span>
            <span id="rainha1Status" class="rainha-status"></span>
        </div>
        <div id="colmeia2" class="colmeia">
            Colmeia 2
            <span class="mel-produzido">Mel: 0</span>
            <span id="rainha2Status" class="rainha-status"></span>
        </div>
    </div>

    <div class="flex space-x-4 mt-6">
        <button id="iniciarSimulacao" class="px-6 py-3 bg-green-500 hover:bg-green-600 text-white font-semibold rounded-xl shadow-lg transition duration-200 ease-in-out transform hover:scale-105">
            Iniciar Simula√ß√£o
        </button>
        <button id="adicionarFlor" class="px-6 py-3 bg-blue-500 hover:bg-blue-600 text-white font-semibold rounded-xl shadow-lg transition duration-200 ease-in-out transform hover:scale-105">
            Adicionar Flor
        </button>
        <button id="adicionarAbelha" class="px-6 py-3 bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-semibold rounded-xl shadow-lg transition duration-200 ease-in-out transform hover:scale-105">
            Adicionar Abelha
        </button>
    </div>

    <div id="eventPopupBackdrop" class="event-popup-backdrop">
        <div id="eventPopupContent" class="event-popup-content">
            <h2 class="text-3xl font-extrabold text-red-600 mb-2">ALERTA DE EVENTO!</h2>
            <p id="eventMessage" class="text-xl text-gray-700 mb-4">Um evento est√° prestes a ocorrer:</p>
            <p class="text-sm text-gray-500 mb-2">Impacto em:</p>
            <div id="eventTimer" class="event-popup-timer">02:00</div>
            <p class="text-base text-gray-600 font-medium italic" id="eventDescription">Prepare-se para o impacto no ecossistema.</p>
        </div>
    </div>


<script>
    document.addEventListener('DOMContentLoaded', () => {
        const ecossistema = document.getElementById('ecossistema');
        const colmeia1 = document.getElementById('colmeia1');
        const colmeia2 = document.getElementById('colmeia2');
        const iniciarBtn = document.getElementById('iniciarSimulacao');
        const adicionarFlorBtn = document.getElementById('adicionarFlor');
        const adicionarAbelhaBtn = document.getElementById('adicionarAbelha'); 

        // Display Status Elements
        const diaJogoDisplay = document.getElementById('diaJogo');
        const statusEventoDisplay = document.getElementById('statusEventoAtual');
        const impactoEventoDisplay = document.getElementById('impactoEvento');
        const melColmeia1Display = document.getElementById('melColmeia1Display');
        const melColmeia2Display = document.getElementById('melColmeia2Display');
        const totalAbelhasDisplay = document.getElementById('totalAbelhas');
        const totalFloresDisplay = document.getElementById('totalFlores');
        const maxAbelhasDisplay = document.getElementById('maxAbelhasDisplay');
        const rainha1StatusDisplay = document.getElementById('rainha1Status');
        const rainha2StatusDisplay = document.getElementById('rainha2Status');
        
        // Popup Elements
        const eventPopupBackdrop = document.getElementById('eventPopupBackdrop');
        const eventTimerDisplay = document.getElementById('eventTimer');
        const eventMessageDisplay = document.getElementById('eventMessage');
        const eventDescriptionDisplay = document.getElementById('eventDescription');


        // --- Vari√°veis de Estado Global e Limites ---
        let MAX_BEES = 50; 
        const MAX_BEES_HEALTHY = 100; // Novo limite para Rainha Saud√°vel
        const BEES_TO_KEEP_AFTER_PREDATOR = 3; 
        const BEES_TO_KEEP_AFTER_QUEEN_DEATH = 2; // Novo limite para Guerra Civil
        const HIVE_ENTRY_TIME = 2000; 
        
        // Cooldowns
        const BEE_ADD_COOLDOWN_MS = 3000; 
        const FLOWER_ADD_COOLDOWN_MS = 3000; 
        
        let isAddingBeeOnCooldown = false; 
        let isAddingFlowerOnCooldown = false; 
        
        let flores = [];
        let abelhas = [];
        let melColmeia1 = 0;
        let melColmeia2 = 0;
        let abelhaId = 0;
        let florId = 0;
        let simulacaoAtiva = false;
        let lastTimestamp = 0;
        let eventTimeout = null; 
        
        // Vari√°veis de Tempo e Evento
        let diaJogo = 1;
        const MILISSEGUNDOS_POR_DIA = 3 * 60 * 1000; // 3 minutos
        let tempoDecorridoDia = 0; 
        let eventoEmAndamento = 'Normal';

        // Vari√°veis de Controle de Evento
        let eventoAtivo = null; 
        let tempoFimEvento = 0; 
        let GAME_SPEED_FACTOR = 1.0; // Fator de velocidade global (para Congelamento)

        // Vari√°veis de Estado da Rainha
        let rainha1Saude = 'Normal'; // 'Normal', 'Saud√°vel', 'N√£o Saud√°vel'
        let rainha2Saude = 'Normal';

        
        // Taxas Base (para serem modificadas pelos eventos)
        const TAXA_PRODUCAO_MEL_BASE = 10;
        
        // Taxa de Movimento Ajustada
        const BASE_SPEED_MIN = 0.5;
        const BASE_SPEED_MAX = 1.5;

        // Limite da Rainha (Inicializado)
        maxAbelhasDisplay.textContent = MAX_BEES;


        // --- Configura√ß√£o dos Eventos (Incluindo Rainha N√£o Saud√°vel) ---
        const DURACAO_EVENTO_SIMPLES_MS = 2 * 60 * 1000; // 2 minutos
        const DURACAO_EVENTO_PREDADOR_MS = 20 * 60 * 1000; // 20 minutos
        const DURACAO_EVENTO_RAINHA_MS = 20 * 60 * 1000; // 20 minutos

        const EVENTOS = {
            // ... (Manter eventos clim√°ticos anteriores)
            'Solo Muito Seco': { tipo: 'RUIM', impacto: 'Flores (-), Mel (-), Natalidade (-)', durationMs: DURACAO_EVENTO_SIMPLES_MS, nectarMultiplier: 0.7, flowerMultiplier: 0.5, natalidadeMultiplier: 0.7, message: 'A seca diminuiu a produ√ß√£o de n√©ctar e o surgimento de novas flores.', isCongelamento: false, travarAddBee: false, },
            'Solo Muito √ömido': { tipo: 'RUIM', impacto: 'Flores (-), Mel (-), Natalidade (-)', durationMs: DURACAO_EVENTO_SIMPLES_MS, nectarMultiplier: 0.8, flowerMultiplier: 0.6, natalidadeMultiplier: 0.8, message: 'O excesso de √°gua atrapalha o crescimento das plantas e afeta a colheita.', isCongelamento: false, travarAddBee: false, },
            'Temperatura Muito Baixa (Congelamento)': { tipo: 'RUIM', impacto: 'CONGELAMENTO: Atividade Zero, Mel (x0), Natalidade (x0)', durationMs: DURACAO_EVENTO_SIMPLES_MS, nectarMultiplier: 0, flowerMultiplier: 0.05, natalidadeMultiplier: 0, message: 'Temperaturas congelantes! As abelhas est√£o em estagna√ß√£o e a produ√ß√£o parou.', isCongelamento: true, travarAddBee: false, },
            'Temperatura Muito Alta (Secagem)': { tipo: 'RUIM', impacto: 'Secagem: Mel (-), Natalidade (-), Flores (-)', durationMs: DURACAO_EVENTO_SIMPLES_MS, nectarMultiplier: 0.6, flowerMultiplier: 0.5, natalidadeMultiplier: 0.6, message: 'Calor intenso e secagem. A atividade de coleta e reprodu√ß√£o √© prejudicada.', isCongelamento: false, travarAddBee: false, },
            'Solo √ömido (Ideal)': { tipo: 'BOM', impacto: 'Flores (++), Mel (x1)', durationMs: DURACAO_EVENTO_SIMPLES_MS, nectarMultiplier: 1.0, flowerMultiplier: 1.5, natalidadeMultiplier: 1.0, message: 'Condi√ß√µes de solo perfeitas. O surgimento de novas flores √© acelerado!', isCongelamento: false, travarAddBee: false, },
            'Temperatura Quente (Moderada)': { tipo: 'BOM', impacto: 'Mel (++), Natalidade (++), Flores (+)', durationMs: DURACAO_EVENTO_SIMPLES_MS, nectarMultiplier: 1.5, flowerMultiplier: 1.2, natalidadeMultiplier: 1.5, message: 'Temperatura agrad√°vel. A colheita de n√©ctar e a natalidade est√£o mais eficientes.', isCongelamento: false, travarAddBee: false, },
            'Solo √ömido + Temp. Quente': { tipo: 'BOM', impacto: 'Super B√¥nus: Mel (+++), Natalidade (+++), Flores (+++)', durationMs: DURACAO_EVENTO_SIMPLES_MS, nectarMultiplier: 2.0, flowerMultiplier: 2.0, natalidadeMultiplier: 2.0, message: 'Combina√ß√£o perfeita de clima e solo! O ecossistema est√° em pleno auge de produ√ß√£o.', isCongelamento: false, travarAddBee: false, },
            'Invas√£o de Predadores': { tipo: 'RUIM', impacto: `Perda de abelhas. Bot√£o de Adicionar travado por 20 minutos. (Sobreviv√™ncia: ${BEES_TO_KEEP_AFTER_PREDATOR} abelhas)`, durationMs: DURACAO_EVENTO_PREDADOR_MS, nectarMultiplier: 0.8, flowerMultiplier: 1.0, natalidadeMultiplier: 0.5, massMortality: true, survivalCount: BEES_TO_KEEP_AFTER_PREDATOR, message: 'Vespas predadoras √† vista! O risco de morte em massa √© iminente. O bot√£o de adicionar abelha foi desativado.', isCongelamento: false, travarAddBee: true, },

            // --- EVENTOS DA NOVA RAINHA ---
            'Rainha Saud√°vel (Prosperidade)': {
                tipo: 'ESPECIAL BOM',
                impacto: `Limite de Abelhas: ${MAX_BEES_HEALTHY}. B√¥nus de Flores/Abelhas.`,
                durationMs: DURACAO_EVENTO_RAINHA_MS,
                nectarMultiplier: 1.0, 
                flowerMultiplier: 1.0, 
                natalidadeMultiplier: 1.0, 
                message: 'Uma nova Rainha saud√°vel chegou! O limite de abelhas aumentou e h√° um surto de nascimento e flora√ß√£o!',
                isCongelamento: false,
                travarAddBee: false,
            },
            'Rainha N√£o Saud√°vel (Guerra Civil)': {
                tipo: 'ESPECIAL RUIM',
                impacto: `Guerra Civil. Bot√£o de Adicionar travado por 20 minutos. (Sobreviv√™ncia: ${BEES_TO_KEEP_AFTER_QUEEN_DEATH} abelhas)`,
                durationMs: DURACAO_EVENTO_RAINHA_MS,
                nectarMultiplier: 0.5, 
                flowerMultiplier: 0.5, 
                natalidadeMultiplier: 0.1, 
                massMortality: true, 
                survivalCount: BEES_TO_KEEP_AFTER_QUEEN_DEATH,
                message: 'A Rainha morreu e a Guerra Civil come√ßou! O bot√£o de adicionar abelha foi desativado.',
                isCongelamento: false,
                travarAddBee: true, 
            }
        };

        // --- Fun√ß√µes de Mec√¢nica de Jogo ---

        function getRandomPosition() {
            const x = Math.random() * (ecossistema.clientWidth - 40) + 20;
            const y = Math.random() * (ecossistema.clientHeight - 40) + 20;
            return { x, y };
        }

        // Cria uma nova flor
        function criarFlor() {
             if (isAddingFlowerOnCooldown && eventoEmAndamento !== 'Rainha Saud√°vel (Prosperidade)') return false;
             
            const pos = getRandomPosition();
            const florDiv = document.createElement('div');
            florDiv.className = 'flor';
            florDiv.style.left = `${pos.x}px`;
            florDiv.style.top = `${pos.y}px`;
            florDiv.dataset.nectar = 100;
            florDiv.dataset.id = florId++;
            
            florDiv.innerHTML = `<span class="nectar-value">${florDiv.dataset.nectar}</span>`;
            
            const tooltip = document.createElement('span');
            tooltip.className = 'flor-tooltip';
            tooltip.textContent = "N√©ctar: 100 | Ocupada: N√£o";
            florDiv.appendChild(tooltip);

            ecossistema.appendChild(florDiv);
            flores.push({ 
                element: florDiv, 
                x: pos.x, 
                y: pos.y, 
                nectar: parseInt(florDiv.dataset.nectar),
                occupiedByBeeId: null 
            });
            totalFloresDisplay.textContent = flores.length;

            florDiv.addEventListener('mouseover', () => {
                const occupiedStatus = flores.find(f => f.element === florDiv)?.occupiedByBeeId !== null ? 'Sim' : 'N√£o';
                const currentTooltip = florDiv.querySelector('.flor-tooltip');
                if (currentTooltip) {
                    currentTooltip.textContent = `N√©ctar: ${florDiv.dataset.nectar} | Ocupada: ${occupiedStatus}`;
                }
            });
            
            return true; 
        }

        // Cria uma nova abelha (com limite)
        function criarAbelha(colmeiaTarget) {
            if (abelhas.length >= MAX_BEES) {
                console.log(`Limite m√°ximo de abelhas (${MAX_BEES}) atingido. N√£o √© poss√≠vel criar mais.`);
                return false; 
            }
            if (eventoAtivo && eventoAtivo.travarAddBee && !isAddingBeeOnCooldown) {
                 // Trava a adi√ß√£o manual apenas durante o evento de predadores/guerra civil
                 console.log(`Bot√£o de Adicionar Abelha travado devido a ${eventoEmAndamento}.`);
                 return false;
            }
            
            const pos = getRandomPosition();
            const abelhaDiv = document.createElement('div');
            abelhaDiv.className = 'abelha';
            abelhaDiv.style.left = `${pos.x}px`;
            abelhaDiv.style.top = `${pos.y}px`;
            const currentBeeId = abelhaId++;
            abelhaDiv.dataset.id = currentBeeId;
            abelhaDiv.dataset.colmeiaTarget = colmeiaTarget || (currentBeeId % 2 === 0 ? 'colmeia1' : 'colmeia2');
            abelhaDiv.dataset.hasNectar = 'false';
            ecossistema.appendChild(abelhaDiv);
            
            abelhas.push({
                element: abelhaDiv,
                id: currentBeeId,
                x: pos.x,
                y: pos.y,
                targetFlor: null,
                hasNectar: false,
                speed: Math.random() * (BASE_SPEED_MAX - BASE_SPEED_MIN) + BASE_SPEED_MIN, 
                state: 'searching', 
                zigZagSeed: Math.random() * 2 * Math.PI,
                isEntering: false 
            });
            totalAbelhasDisplay.textContent = abelhas.length;
            return true; 
        }
        
        // Timer de Renova√ß√£o de Flores (6 segundos)
        const TEMPO_RENOVACAO = 6000;

        function iniciarTimerRemocao(florObj) {
            if (florObj.element.classList.contains('sem-nectar') && !florObj.element.dataset.removing) {
                florObj.element.dataset.removing = 'true';
                
                setTimeout(() => {
                    florObj.element.remove();

                    const idParaRemover = florObj.element.dataset.id;
                    const index = flores.findIndex(f => f.element.dataset.id === idParaRemover);
                    
                    if (index > -1) {
                        flores.splice(index, 1);
                        totalFloresDisplay.textContent = flores.length;
                    }

                }, TEMPO_RENOVACAO);
            }
        }

        function moverAbelha(abelha, targetX, targetY, currentSpeedFactor) {
            // A velocidade da abelha √© modulada pelo fator de velocidade do jogo (ex: congelamento)
            const currentSpeed = abelha.speed * currentSpeedFactor; 

            const dx = targetX - abelha.x;
            const dy = targetY - abelha.y;
            const distance = Math.sqrt(dx * dx + dy * dy);

            if (distance <= currentSpeed) {
                abelha.x = targetX;
                abelha.y = targetY;
                return true; 
            }

            const angleToTarget = Math.atan2(dy, dx);
            
            const oscillation = Math.sin(abelha.zigZagSeed) * 1.5; 
            abelha.zigZagSeed += 0.1; 

            const perpendicularAngle = angleToTarget + Math.PI / 2;

            const baseMoveX = Math.cos(angleToTarget) * currentSpeed;
            const baseMoveY = Math.sin(angleToTarget) * currentSpeed;

            const zigZagX = Math.cos(perpendicularAngle) * oscillation;
            const zigZagY = Math.sin(perpendicularAngle) * oscillation;
            
            abelha.x += baseMoveX + zigZagX;
            abelha.y += baseMoveY + zigZagY;

            abelha.element.style.left = `${abelha.x}px`;
            abelha.element.style.top = `${abelha.y}px`;
            return false; 
        }
        
        // --- L√≥gica de Eventos Aleat√≥rios ---
        function sortearEvento() {
             resetarEvento();
             
             if (Math.random() < 0.3) { // 30% de chance de evento clim√°tico
                 const eventKeys = Object.keys(EVENTOS).filter(key => 
                     key !== 'Rainha Saud√°vel (Prosperidade)' && key !== 'Rainha N√£o Saud√°vel (Guerra Civil)'
                 );
                 const randomKey = eventKeys[Math.floor(Math.random() * eventKeys.length)];
                 
                 aplicarImpactoEvento(randomKey);

             } else {
                 eventoEmAndamento = 'Normal';
                 statusEventoDisplay.textContent = 'Normal';
                 impactoEventoDisplay.textContent = 'Nenhum';
             }
        }

        function mostrarAlertaEvento(titulo, mensagem, tipo, durationMs) {
            eventMessageDisplay.textContent = titulo;
            eventDescriptionDisplay.textContent = mensagem;
            
            let timeLeft = Math.ceil(durationMs / 1000);
            eventPopupBackdrop.style.display = 'flex';
            
            let currentType;
            if (tipo === 'BOM' || tipo === 'ESPECIAL BOM') {
                 currentType = 'bg-green-100 border-green-500';
            } else if (tipo === 'RUIM' || tipo === 'ESPECIAL RUIM') {
                 currentType = 'bg-red-100 border-red-500';
            } else {
                 currentType = 'bg-yellow-100 border-yellow-500';
            }
            document.getElementById('eventPopupContent').className = `event-popup-content ${currentType}`;

            if (eventTimeout) clearTimeout(eventTimeout);
            
            const countdownInterval = setInterval(() => {
                timeLeft--;
                const minutes = String(Math.floor(timeLeft / 60)).padStart(2, '0');
                const seconds = String(timeLeft % 60).padStart(2, '0');
                eventTimerDisplay.textContent = `${minutes}:${seconds}`;

                if (timeLeft <= 0) {
                    clearInterval(countdownInterval);
                    eventPopupBackdrop.style.display = 'none';
                }
            }, 1000);
            
            eventTimeout = setTimeout(() => {
                eventPopupBackdrop.style.display = 'none';
            }, durationMs);
        }

        function aplicarImpactoEvento(eventoKey) {
            const evento = EVENTOS[eventoKey];
            eventoAtivo = evento;
            tempoFimEvento = performance.now() + evento.durationMs; 
            
            eventoEmAndamento = eventoKey;
            impactoEventoDisplay.textContent = evento.impacto;

            // Alerta visual
            mostrarAlertaEvento(eventoKey, evento.message, evento.tipo, evento.durationMs);

            // Ajusta o fator de velocidade para o congelamento
            GAME_SPEED_FACTOR = evento.isCongelamento ? 0.05 : 1.0; 
            
            // Trava o bot√£o de adicionar abelha
            if (evento.travarAddBee) {
                adicionarAbelhaBtn.disabled = true;
                adicionarAbelhaBtn.textContent = 'Abelha (Travado)';
            }

            // L√≥gica de Mortalidade em Massa (Predadores ou Guerra Civil)
            if (evento.massMortality) {
                // Ao final do evento, a mortalidade em massa √© aplicada
                setTimeout(() => {
                    if (abelhas.length > evento.survivalCount) {
                        // Calcula quantas abelhas precisam ser removidas
                        const toRemove = abelhas.length - evento.survivalCount;
                        for(let i = 0; i < toRemove; i++) {
                             const bee = abelhas.pop();
                             bee.element.remove();
                        }
                        totalAbelhasDisplay.textContent = abelhas.length;
                        console.log(`${eventoKey} terminou. ${toRemove} abelhas removidas. Restam ${abelhas.length}.`);
                    }
                    // Garante o destrave do bot√£o no final do evento
                    resetarEvento(); 
                }, evento.durationMs);
            }
        }
        
        function resetarEvento() {
            if (eventTimeout) clearTimeout(eventTimeout);
            
            eventoAtivo = null;
            tempoFimEvento = 0;
            GAME_SPEED_FACTOR = 1.0; 

            // Resetar Limite de Abelhas para o padr√£o (50) ou para o limite da Rainha (100)
            if (rainha1Saude === 'Saud√°vel' || rainha2Saude === 'Saud√°vel') {
                 MAX_BEES = MAX_BEES_HEALTHY;
            } else {
                 MAX_BEES = 50; 
            }
            maxAbelhasDisplay.textContent = MAX_BEES;
            
            // Destravar bot√£o de adicionar abelha
            adicionarAbelhaBtn.disabled = false;
            adicionarAbelhaBtn.textContent = 'Adicionar Abelha'; 
            
            // Resetar display
            eventoEmAndamento = 'Normal';
            statusEventoDisplay.textContent = 'Normal';
            impactoEventoDisplay.textContent = 'Nenhum';
        }
        
        // --- NOVO EVENTO: NOVA RAINHA ---
        function iniciarEventoNovaRainha() {
            // Sorteia a sa√∫de da nova rainha (50/50)
            const isHealthy = Math.random() < 0.5;
            
            // Assume que o evento afeta ambas as colmeias por simplicidade na IA global
            rainha1Saude = isHealthy ? 'Saud√°vel' : 'N√£o Saud√°vel';
            rainha2Saude = isHealthy ? 'Saud√°vel' : 'N√£o Saud√°vel';

            rainha1StatusDisplay.textContent = isHealthy ? '‚ù§Ô∏è' : 'üíÄ';
            rainha2StatusDisplay.textContent = isHealthy ? '‚ù§Ô∏è' : 'üíÄ';

            let eventoKey;

            if (isHealthy) {
                eventoKey = 'Rainha Saud√°vel (Prosperidade)';
                aplicarImpactoEvento(eventoKey);

                // Benef√≠cios da Prosperidade (Sem Cooldown)
                MAX_BEES = MAX_BEES_HEALTHY;
                maxAbelhasDisplay.textContent = MAX_BEES;
                
                // Aumenta o n√∫mero de abelhas (5x) e flores (5x) sem cooldown
                for (let i = 0; i < 5; i++) {
                    criarAbelha();
                    criarFlor();
                }
                
                // O bot√£o de adicionar abelha deve ser destravado imediatamente
                adicionarAbelhaBtn.disabled = false;
                adicionarAbelhaBtn.textContent = 'Adicionar Abelha'; 
                // E o cooldown √© ignorado (simulando a prosperidade)
                isAddingBeeOnCooldown = false;
                isAddingFlowerOnCooldown = false;

            } else {
                eventoKey = 'Rainha N√£o Saud√°vel (Guerra Civil)';
                aplicarImpactoEvento(eventoKey);
                
                // O limite de MAX_BEES √© mantido (50), mas a condi√ß√£o de sobreviv√™ncia √© 2 abelhas,
                // imposta pela l√≥gica de massMortality no final do evento.
            }
            
            // Ap√≥s o fim do evento, os status da rainha voltam a ser 'Normal'
            setTimeout(() => {
                 rainha1StatusDisplay.textContent = '';
                 rainha2StatusDisplay.textContent = '';
                 rainha1Saude = 'Normal';
                 rainha2Saude = 'Normal';
                 resetarEvento(); // Garante o reset do MAX_BEES e do bot√£o
            }, DURACAO_EVENTO_RAINHA_MS);
        }

        
        // --- Fun√ß√£o Auxiliar para Coordenadas da Colmeia ---
        function getColmeiaCoords(colmeiaId) {
            const targetColmeiaElement = document.getElementById(colmeiaId);
            const colmeiaRect = targetColmeiaElement.getBoundingClientRect();
            const ecoRect = ecossistema.getBoundingClientRect();
            
            // Centro da colmeia
            const colmeiaX = colmeiaRect.left + colmeiaRect.width / 2 - ecoRect.left;
            const colmeiaY = colmeiaRect.top + colmeiaRect.height / 2 - ecoRect.top;
            return { colmeiaX, colmeiaY };
        }


        // L√≥gica principal da simula√ß√£o
        function simular(timestamp) {
            if (!simulacaoAtiva) {
                lastTimestamp = timestamp;
                requestAnimationFrame(simular);
                return;
            }

            const deltaTime = timestamp - lastTimestamp;
            lastTimestamp = timestamp;

            // --- L√≥gica de Progress√£o do Tempo do Dia e Eventos ---
            tempoDecorridoDia += deltaTime;

            if (tempoDecorridoDia >= MILISSEGUNDOS_POR_DIA) {
                diaJogo++;
                tempoDecorridoDia = 0;
                diaJogoDisplay.textContent = diaJogo;
                
                // Checagem do Evento Nova Rainha (a cada 10 dias)
                if (diaJogo % 10 === 0) {
                    iniciarEventoNovaRainha();
                } else {
                    sortearEvento(); // Sorteia evento clim√°tico nos demais dias
                }
            }
            // --- FIM L√≥gica de Progress√£o do Tempo do Dia ---
            
            // --- Controle de Fim de Evento Clim√°tico (n√£o Rainha, pois Rainha tem l√≥gica pr√≥pria) ---
            if (eventoAtivo && timestamp > tempoFimEvento && eventoAtivo.durationMs !== DURACAO_EVENTO_RAINHA_MS) {
                console.log(`Fim do evento: ${eventoEmAndamento}. Resetando para Normal.`);
                resetarEvento();
            }

            // --- L√≥gica de Coleta e Movimento das Abelhas (IA Aprimorada) ---
            const nectarMult = eventoAtivo ? eventoAtivo.nectarMultiplier : 1.0;
            
            abelhas.forEach(abelha => {
                
                if (abelha.isEntering) {
                    return; 
                }
                
                const { colmeiaX, colmeiaY } = getColmeiaCoords(abelha.element.dataset.colmeiaTarget);
                
                // 1. === ESTADO DE ESPERA (WAITING) ===
                if (abelha.state === 'waiting') {
                    const availableFlower = flores.find(f => f.nectar > 0 && f.occupiedByBeeId === null);
                    
                    if (availableFlower) {
                        abelha.targetFlor = availableFlower;
                        availableFlower.occupiedByBeeId = abelha.id; 
                        availableFlower.element.classList.add('ocupada');
                        abelha.state = 'collecting';
                    } else {
                        const waitX = colmeiaX + Math.sin(abelha.zigZagSeed * 0.2) * 15;
                        const waitY = colmeiaY + Math.cos(abelha.zigZagSeed * 0.2) * 15;
                        moverAbelha(abelha, waitX, waitY, GAME_SPEED_FACTOR); 
                        return;
                    }
                }

                // 2. === ESTADO DE RETORNO (Com N√©ctar ou Para Esperar) ===
                if (abelha.hasNectar || abelha.state === 'returning_to_wait') {
                    if (moverAbelha(abelha, colmeiaX, colmeiaY, GAME_SPEED_FACTOR)) {
                        
                        abelha.isEntering = true;
                        abelha.element.classList.add('entering-hive'); 

                        setTimeout(() => {
                            abelha.isEntering = false;
                            abelha.element.classList.remove('entering-hive');
                            
                            const offset = Math.random() * 20 - 10; 
                            abelha.x = colmeiaX + offset;
                            abelha.y = colmeiaY + offset;
                            abelha.element.style.left = `${abelha.x}px`;
                            abelha.element.style.top = `${abelha.y}px`;


                            if (abelha.hasNectar) {
                                abelha.hasNectar = false;
                                abelha.element.classList.remove('com-nectar');
                                
                                const melProduzido = TAXA_PRODUCAO_MEL_BASE * nectarMult; 
                                if (abelha.element.dataset.colmeiaTarget === 'colmeia1') {
                                    melColmeia1 += melProduzido;
                                    colmeia1.querySelector('.mel-produzido').textContent = `Mel: ${Math.floor(melColmeia1)}`;
                                    melColmeia1Display.textContent = Math.floor(melColmeia1);
                                } else {
                                    melColmeia2 += melProduzido;
                                    colmeia2.querySelector('.mel-produzido').textContent = `Mel: ${Math.floor(melColmeia2)}`;
                                    melColmeia2Display.textContent = Math.floor(melColmeia2);
                                }
                                abelha.state = 'searching'; 
                            } else if (abelha.state === 'returning_to_wait') {
                                abelha.state = 'waiting'; 
                            }
                            abelha.targetFlor = null;

                        }, HIVE_ENTRY_TIME); 
                    }
                    return;
                } 
                
                // 3. === ESTADO DE BUSCA E COLETA ===
                if (abelha.state === 'searching' || abelha.state === 'collecting') {
                    
                    if (abelha.targetFlor && (abelha.targetFlor.nectar <= 0 || (abelha.targetFlor.occupiedByBeeId !== abelha.id && abelha.targetFlor.occupiedByBeeId !== null))) {
                        if (abelha.targetFlor.occupiedByBeeId === abelha.id) {
                            abelha.targetFlor.occupiedByBeeId = null; 
                            abelha.targetFlor.element.classList.remove('ocupada');
                        }
                        abelha.targetFlor = null; 
                        abelha.state = 'searching';
                    }

                    if (!abelha.targetFlor) {
                        let closestFlor = null;
                        let minDistance = Infinity;

                        const availableFlores = flores.filter(f => f.nectar > 0 && f.occupiedByBeeId === null);

                        if (availableFlores.length > 0) {
                            availableFlores.forEach(flor => {
                                const distance = Math.sqrt(Math.pow(flor.x - abelha.x, 2) + Math.pow(flor.y - abelha.y, 2));
                                if (distance < minDistance) {
                                    minDistance = distance;
                                    closestFlor = flor;
                                }
                            });

                            if (closestFlor) {
                                abelha.targetFlor = closestFlor;
                                closestFlor.occupiedByBeeId = abelha.id; 
                                closestFlor.element.classList.add('ocupada');
                                abelha.state = 'collecting';
                            }
                        } else {
                            abelha.state = 'returning_to_wait';
                            return;
                        }
                    }

                    if (abelha.targetFlor && abelha.state === 'collecting') {
                        if (moverAbelha(abelha, abelha.targetFlor.x, abelha.targetFlor.y, GAME_SPEED_FACTOR)) {
                            if (abelha.targetFlor.nectar > 0) {
                                abelha.targetFlor.nectar -= 10;
                                abelha.targetFlor.element.dataset.nectar = abelha.targetFlor.nectar;
                                
                                abelha.targetFlor.element.querySelector('.nectar-value').textContent = abelha.targetFlor.nectar;
                                
                                abelha.hasNectar = true;
                                abelha.element.classList.add('com-nectar');
                                
                                abelha.targetFlor.occupiedByBeeId = null; 
                                abelha.targetFlor.element.classList.remove('ocupada');

                                abelha.state = 'returning'; 
                            
                                if (abelha.targetFlor.nectar <= 0) {
                                    abelha.targetFlor.element.classList.add('sem-nectar');
                                    iniciarTimerRemocao(abelha.targetFlor);
                                }
                            } else {
                                abelha.targetFlor.occupiedByBeeId = null; 
                                abelha.targetFlor.element.classList.remove('ocupada');
                                abelha.targetFlor = null;
                                abelha.state = 'searching';
                            }
                        }
                    }
                }
            });
            // --- FIM L√≥gica de Coleta e Movimento das Abelhas ---

            // --- Atualiza√ß√£o do Display (Contadores) ---
            totalAbelhasDisplay.textContent = abelhas.length;
            totalFloresDisplay.textContent = flores.length;
            // --- FIM Atualiza√ß√£o do Display ---


            requestAnimationFrame(simular); // Loop de anima√ß√£o
        }

        // --- Event Listeners dos Bot√µes ---
        iniciarBtn.addEventListener('click', () => {
            simulacaoAtiva = !simulacaoAtiva;
            iniciarBtn.textContent = simulacaoAtiva ? 'Pausar Simula√ß√£o' : 'Iniciar Simula√ß√£o';
            if (simulacaoAtiva) {
                lastTimestamp = performance.now();
                requestAnimationFrame(simular);
            } else {
                if (eventTimeout) clearTimeout(eventTimeout); 
            }
        });

        // Cooldown no bot√£o Adicionar Flor - √öNICO PONTO DE CRIA√á√ÉO DE FLORES
        adicionarFlorBtn.addEventListener('click', () => {
             // O evento de Rainha Saud√°vel ignora o cooldown
            if (isAddingFlowerOnCooldown && eventoEmAndamento !== 'Rainha Saud√°vel (Prosperidade)') {
                return; 
            }
            
            if (criarFlor()) {
                if (eventoEmAndamento !== 'Rainha Saud√°vel (Prosperidade)') {
                    // Iniciar Cooldown
                    isAddingFlowerOnCooldown = true;
                    adicionarFlorBtn.disabled = true;
                    
                    let cooldownTimer = Math.ceil(FLOWER_ADD_COOLDOWN_MS / 1000);
                    adicionarFlorBtn.textContent = `Aguarde (${cooldownTimer}s)`;

                    const countdownInterval = setInterval(() => {
                        cooldownTimer--;
                        adicionarFlorBtn.textContent = `Aguarde (${cooldownTimer}s)`;

                        if (cooldownTimer <= 0) {
                            clearInterval(countdownInterval);
                            isAddingFlowerOnCooldown = false;
                            adicionarFlorBtn.disabled = false;
                            adicionarFlorBtn.textContent = 'Adicionar Flor';
                        }
                    }, 1000); 
                }
            }
        });
        
        // Cooldown no bot√£o Adicionar Abelha - √öNICO PONTO DE CRIA√á√ÉO DE ABELHAS (AL√âM DO IN√çCIO)
        adicionarAbelhaBtn.addEventListener('click', () => {
             // O evento de Rainha Saud√°vel ignora o cooldown
            if (isAddingBeeOnCooldown && eventoEmAndamento !== 'Rainha Saud√°vel (Prosperidade)') {
                return; 
            }
            
            // Tenta criar a abelha
            if (criarAbelha()) {
                if (eventoEmAndamento !== 'Rainha Saud√°vel (Prosperidade)') {
                    // Iniciar Cooldown se a abelha foi criada com sucesso
                    isAddingBeeOnCooldown = true;
                    adicionarAbelhaBtn.disabled = true;
                    
                    let cooldownTimer = Math.ceil(BEE_ADD_COOLDOWN_MS / 1000);
                    adicionarAbelhaBtn.textContent = `Aguarde (${cooldownTimer}s)`;

                    const countdownInterval = setInterval(() => {
                        cooldownTimer--;
                        adicionarAbelhaBtn.textContent = `Aguarde (${cooldownTimer}s)`;

                        if (cooldownTimer <= 0) {
                            clearInterval(countdownInterval);
                            isAddingBeeOnCooldown = false;
                            adicionarAbelhaBtn.disabled = false;
                            adicionarAbelhaBtn.textContent = 'Adicionar Abelha';
                        }
                    }, 1000); 
                }
            }
        });

        // --- Inicializa√ß√£o (Apenas para come√ßar o jogo com elementos) ---
        for (let i = 0; i < 5; i++) {
            criarFlor();
        }
        for (let i = 0; i < 2; i++) { 
            criarAbelha(i % 2 === 0 ? 'colmeia1' : 'colmeia2');
        }
        totalAbelhasDisplay.textContent = abelhas.length;
        totalFloresDisplay.textContent = flores.length;
    });
</script>
</body>
</html>


