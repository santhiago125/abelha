<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Beeblom: Ecossistema de Simula√ß√£o (V19 - Guerra Civil)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Base de Estiliza√ß√£o */
        .ecossistema {
            width: 100%;
            height: 60vh;
            background-color: #e0f2f1; /* Tom suave de azul/verde para o c√©u */
            position: relative;
            overflow: hidden;
            border-radius: 1rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            border: 2px dashed #b9d7ea;
        }

        /* Colmeias */
        .colmeia {
            position: absolute;
            width: 150px;
            height: 100px;
            background-color: #ffc107; /* Amarelo da colmeia */
            border-radius: 0 0 75px 75px;
            border: 5px solid #ff9800;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: #333;
            font-weight: bold;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            z-index: 10;
        }
        #colmeia1 { top: 10%; left: 5%; }
        #colmeia2 { bottom: 10%; right: 5%; }
        .rainha-status {
            font-size: 1.5rem;
            margin-top: 5px;
        }
        
        /* --- ESTILOS DE ABELHA --- */
        .bee-base {
            position: absolute;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid #000;
            z-index: 20;
            transition: opacity 0.3s ease-in-out; 
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
        }

        /* Abelhas Originais (Amarelas) */
        .abelha {
            background-color: #ffeb3b; /* Amarelo da abelha */
        }
        /* Efeito de listras pretas (simula√ß√£o) */
        .abelha::before {
            content: '';
            position: absolute;
            width: 100%;
            height: 50%;
            top: 25%;
            left: 0;
            background: repeating-linear-gradient(
                45deg,
                black,
                black 3px,
                transparent 3px,
                transparent 6px
            );
            border-radius: 50%;
        }
        
        /* Abelhas Invasoras (Vermelhas) */
        .abelha-invasora {
            background-color: #f44336; /* Vermelho forte */
            border-color: #b71c1c; /* Borda mais escura */
            transform: rotate(45deg); /* Para diferenciar visualmente */
        }
        .abelha-invasora::before {
             content: 'X';
             color: white;
             font-weight: bold;
             font-size: 0.75rem;
             line-height: 1;
        }
        
        /* Abelhas em Guerra Civil (Amarelas com Borda Vermelha) */
        .abelha.em-guerra {
            border-color: #b71c1c; /* Borda Vermelha forte para indicar hostilidade */
            box-shadow: 0 0 8px 2px rgba(244, 67, 54, 0.7); /* Sombra vermelha */
        }

        .abelha.com-nectar {
            box-shadow: 0 0 10px 3px #e91e63; /* Cor-de-rosa para n√©ctar */
        }
        .abelha:hover, .abelha-invasora:hover {
            transform: scale(1.3);
        }
        
        /* Efeito de sumir ao entrar na colmeia */
        .abelha.entering-hive {
            opacity: 0;
        }
        
        /* --- BARRA DE VIDA (HP BAR) --- */
        .hp-bar-container {
            position: absolute;
            top: -8px; /* Posiciona acima da abelha */
            left: -5px;
            width: 30px; 
            height: 3px;
            background-color: #e0e0e0;
            border-radius: 1px;
            overflow: hidden;
        }
        .hp-bar {
            height: 100%;
            background-color: #4caf50; /* Verde */
            transition: width 0.3s ease;
        }
        .abelha-invasora .hp-bar {
            background-color: #f44336; /* Vermelho */
        }
        .abelha.em-guerra .hp-bar {
            background-color: #f59e0b; /* Laranja/Amarelo de Alerta */
        }
        /* --- FIM BARRA DE VIDA --- */

        /* Flores */
        .flor {
            position: absolute;
            width: 30px;
            height: 30px;
            background-color: #f44336; /* Flor vermelha */
            border-radius: 50%;
            border: 2px solid #880e4f;
            display: flex;
            flex-direction: column; 
            justify-content: center;
            align-items: center;
            color: #333; 
            font-size: 10px;
            font-weight: bold;
            cursor: pointer;
            z-index: 15;
            transition: background-color 0.5s, box-shadow 0.5s;
        }
        
        /* Tooltip de Detalhes da Flor */
        .flor-tooltip {
            position: absolute;
            bottom: 110%; 
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.85); 
            color: #fff; 
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 10px;
            font-weight: normal;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none; 
            transition: opacity 0.2s ease;
            z-index: 30;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            text-align: center;
        }

        /* Mostrar Tooltip ao passar o mouse */
        .flor:hover .flor-tooltip {
            opacity: 1;
        }

        /* Estilo para flor esgotada (cinza) */
        .flor.sem-nectar {
            background-color: #9e9e9e; 
            border-color: #616161;
            box-shadow: none;
            color: #333;
            transition: all 0.5s ease-in-out;
            cursor: default;
        }
        
        /* Estilo para flor ocupada (borda verde ou algo que indique uso) */
        .flor.ocupada {
             border-color: #10b981; 
             box-shadow: 0 0 5px 2px #34d399;
        }

        /* Painel de Status/Tempo */
        .status-panel {
            background-color: #ffffff;
            border-radius: 0.75rem;
            padding: 1rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }
        .status-item i {
            font-size: 1.5rem;
            margin-right: 0.5rem;
        }

        /* Alerta N√£o-Bloqueante Flutuante */
        #floatingAlert {
            position: fixed;
            top: 1rem;
            right: 1rem;
            background-color: #fefcbf; /* Amarelo Suave */
            border: 3px solid #f59e0b; /* Laranja de Alerta */
            color: #92400e; /* Marrom Escuro */
            padding: 0.75rem 1.25rem;
            border-radius: 0.75rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            z-index: 999; 
            max-width: 300px;
            display: none; /* Inicia oculto */
            animation: slideIn 0.5s ease-out;
        }
        @keyframes slideIn {
            from { right: -320px; opacity: 0; }
            to { right: 1rem; opacity: 1; }
        }

    </style>
</head>
<body class="bg-gray-100 min-h-screen p-4 flex flex-col items-center font-sans">

    <h1 class="text-4xl font-extrabold text-gray-800 mb-6 mt-4">Beeblom: Ecossistema de Simula√ß√£o</h1>

    <div id="statusPanel" class="status-panel w-full max-w-4xl mb-6 grid grid-cols-2 md:grid-cols-5 gap-4">
        <div class="status-item flex items-center bg-blue-50 p-3 rounded-lg border border-blue-200">
            <i class="fas fa-calendar-day text-blue-500"></i>
            <div>
                <p class="text-sm font-medium text-gray-500">Dia de Jogo</p>
                <p id="diaJogo" class="text-xl font-bold text-blue-700">1</p>
            </div>
        </div>
        <div class="status-item flex items-center bg-yellow-50 p-3 rounded-lg border border-yellow-200">
            <i class="fas fa-cloud-sun text-yellow-500"></i>
            <div>
                <p class="text-sm font-medium text-gray-500">Status Clim√°tico</p>
                <p id="statusEventoAtual" class="text-xl font-bold text-yellow-700">Normal</p>
            </div>
        </div>
        <div class="status-item flex items-center bg-red-50 p-3 rounded-lg border border-red-200">
            <i class="fas fa-exclamation-triangle text-red-500"></i>
            <div>
                <p class="text-sm font-medium text-gray-500">Efeito</p>
                <p id="impactoEvento" class="text-xl font-bold text-red-700">Nenhum</p>
            </div>
        </div>
        <div class="status-item flex items-center bg-indigo-50 p-3 rounded-lg border border-indigo-200">
            <i class="fas fa-hourglass-half text-indigo-500"></i>
            <div>
                <p class="text-sm font-medium text-gray-500">Dura√ß√£o do Evento</p>
                <p id="eventTimerDisplay" class="text-xl font-bold text-indigo-700">--</p>
            </div>
        </div>
        <div class="status-item flex items-center bg-gray-50 p-3 rounded-lg border border-gray-200">
            <i class="fas fa-bullseye text-gray-500"></i>
            <div>
                <p class="text-sm font-medium text-gray-500">Limite de Abelhas</p>
                <p id="maxAbelhasDisplay" class="text-xl font-bold text-gray-700">50</p>
            </div>
        </div>
        <div class="status-item flex items-center bg-green-50 p-3 rounded-lg border border-green-200">
            <i class="fas fa-flask text-green-500"></i>
            <div>
                <p class="text-sm font-medium text-gray-500">Mel Colmeia 1</p>
                <p id="melColmeia1Display" class="text-xl font-bold text-green-700">0</p>
            </div>
        </div>
        <div class="status-item flex items-center bg-green-50 p-3 rounded-lg border border-green-200">
            <i class="fas fa-flask text-green-500"></i>
            <div>
                <p class="text-sm font-medium text-gray-500">Mel Colmeia 2</p>
                <p id="melColmeia2Display" class="text-xl font-bold text-green-700">0</p>
            </div>
        </div>
        <div class="status-item flex items-center bg-purple-50 p-3 rounded-lg border border-purple-200">
            <i class="fas fa-bee text-purple-500"></i>
            <div>
                <p class="text-sm font-medium text-gray-500">Abelhas Vivas (Amarelas)</p>
                <p id="totalAbelhas" class="text-xl font-bold text-purple-700">0</p>
            </div>
        </div>
        <div class="status-item flex items-center bg-red-50 p-3 rounded-lg border border-red-200">
            <i class="fas fa-skull text-red-500"></i>
            <div>
                <p class="text-sm font-medium text-gray-500">Invasoras (Vermelhas)</p>
                <p id="totalAbelhasInvasoras" class="text-xl font-bold text-red-700">0</p>
            </div>
        </div>
        <div class="status-item flex items-center bg-pink-50 p-3 rounded-lg border border-pink-200">
            <i class="fas fa-seedling text-pink-500"></i>
            <div>
                <p class="text-sm font-medium text-gray-500">Flores Ativas</p>
                <p id="totalFlores" class="text-xl font-bold text-pink-700">0</p>
            </div>
        </div>
    </div>

    <div id="ecossistema" class="ecossistema w-full max-w-4xl">
        <div id="colmeia1" class="colmeia">
            Colmeia 1
            <span class="mel-produzido">Mel: 0</span>
            <span id="rainha1Status" class="rainha-status"></span>
        </div>
        <div id="colmeia2" class="colmeia">
            Colmeia 2
            <span class="mel-produzido">Mel: 0</span>
            <span id="rainha2Status" class="rainha-status"></span>
        </div>
    </div>

    <div class="flex space-x-4 mt-6">
        <button id="iniciarSimulacao" class="px-6 py-3 bg-green-500 hover:bg-green-600 text-white font-semibold rounded-xl shadow-lg transition duration-200 ease-in-out transform hover:scale-105">
            Iniciar Simula√ß√£o
        </button>
        <button id="adicionarFlor" class="px-6 py-3 bg-blue-500 hover:bg-blue-600 text-white font-semibold rounded-xl shadow-lg transition duration-200 ease-in-out transform hover:scale-105">
            Adicionar Flor
        </button>
        <button id="adicionarAbelha" class="px-6 py-3 bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-semibold rounded-xl shadow-lg transition duration-200 ease-in-out transform hover:scale-105">
            Adicionar Abelha
        </button>
    </div>

    <div id="floatingAlert">
        <h3 id="alertTitle" class="text-lg font-bold">ALERTA DE EVENTO!</h3>
        <p id="alertMessage" class="text-sm"></p>
    </div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const ecossistema = document.getElementById('ecossistema');
        const iniciarBtn = document.getElementById('iniciarSimulacao');
        const adicionarFlorBtn = document.getElementById('adicionarFlor');
        const adicionarAbelhaBtn = document.getElementById('adicionarAbelha'); 

        // Display Status Elements
        const diaJogoDisplay = document.getElementById('diaJogo');
        const statusEventoDisplay = document.getElementById('statusEventoAtual');
        const impactoEventoDisplay = document.getElementById('impactoEvento');
        const melColmeia1Display = document.getElementById('melColmeia1Display');
        const melColmeia2Display = document.getElementById('melColmeia2Display');
        const totalAbelhasDisplay = document.getElementById('totalAbelhas');
        const totalFloresDisplay = document.getElementById('totalFlores');
        const maxAbelhasDisplay = document.getElementById('maxAbelhasDisplay');
        const rainha1StatusDisplay = document.getElementById('rainha1Status');
        const rainha2StatusDisplay = document.getElementById('rainha2Status');
        const eventTimerDisplay = document.getElementById('eventTimerDisplay');
        const totalAbelhasInvasorasDisplay = document.getElementById('totalAbelhasInvasoras');

        // Floating Alert Elements
        const floatingAlert = document.getElementById('floatingAlert');
        const alertTitle = document.getElementById('alertTitle');
        const alertMessage = document.getElementById('alertMessage');


        // --- Vari√°veis de Estado Global e Limites ---
        let MAX_BEES = 50; 
        const MAX_BEES_HEALTHY = 100;
        const COMBAT_SURVIVAL_LIMIT_INVASION = 3; // Limite de abelhas amarelas ap√≥s o combate de INVAS√ÉO
        const CIVIL_WAR_SURVIVAL_LIMIT = 2; // Limite de abelhas amarelas ap√≥s o combate de GUERRA CIVIL

        const HIVE_ENTRY_TIME = 2000; 
        const INITIAL_HP = 100;
        const ATTACK_DAMAGE = 8;
        const ATTACK_RATE = 500; // 500ms entre ataques

        
        // Cooldowns
        const BEE_ADD_COOLDOWN_MS = 3000; 
        const FLOWER_ADD_COOLDOWN_MS = 3000; 
        
        let isAddingBeeOnCooldown = false; 
        let isAddingFlowerOnCooldown = false; 
        
        let flores = [];
        let abelhas = []; // Abelhas Amarelas (Originais)
        let abelhasInvasoras = []; // Abelhas Vermelhas (Invasoras)
        let melColmeia1 = 0;
        let melColmeia2 = 0;
        let abelhaId = 0;
        let florId = 0;
        let simulacaoIniciada = false; // Novo estado para saber se a simula√ß√£o foi executada pelo menos uma vez
        let simulacaoAtiva = false; // Estado de Pausa/Continua√ß√£o
        let animationFrameId = null; // ID para controle do requestAnimationFrame
        let lastTimestamp = 0;
        
        // Vari√°veis de Tempo e Evento
        let diaJogo = 1;
        const MILISSEGUNDOS_POR_DIA = 3 * 60 * 1000; // 3 minutos
        let tempoDecorridoDia = 0; 
        let eventoEmAndamento = 'Normal';

        // Vari√°veis de Controle de Evento
        let eventoAtivo = null; 
        let tempoFimEvento = 0; 
        let GAME_SPEED_FACTOR = 1.0; 
        let countdownInterval = null; 
        let lastAttackTimestamp = 0;

        // Vari√°veis de Estado da Rainha
        let rainha1Saude = 'Normal'; 
        let rainha2Saude = 'Normal';

        
        // Taxas Base (para serem modificadas pelos eventos)
        const TAXA_PRODUCAO_MEL_BASE = 10;
        
        // CORRE√á√ÉO: Velocidade lenta com zig-zag mantido
        const BASE_SPEED_MIN = 0.5; // Valor mais baixo para velocidade lenta
        const BASE_SPEED_MAX = 1.0; // Valor mais baixo para velocidade lenta


        // --- Configura√ß√£o dos Eventos ---
        const DURACAO_EVENTO_SIMPLES_MS = 2 * 60 * 1000; 
        const DURACAO_EVENTO_COMBATE_MS = 20 * 60 * 1000; // 20 minutos
        const DURACAO_EVENTO_RAINHA_MS = 20 * 60 * 1000; 

        const EVENTOS = {
            'Solo Muito Seco': { tipo: 'RUIM', impacto: 'Flores (-), Mel (-), Natalidade (-)', durationMs: DURACAO_EVENTO_SIMPLES_MS, nectarMultiplier: 0.7, flowerMultiplier: 0.5, natalidadeMultiplier: 0.7, message: 'A seca diminuiu a produ√ß√£o de n√©ctar e o surgimento de novas flores.', isCongelamento: false, travarAddBee: false, isCombatEvent: false, isCivilWar: false },
            'Temperatura Muito Baixa (Congelamento)': { tipo: 'RUIM', impacto: 'CONGELAMENTO: Atividade Zero, Mel (x0), Natalidade (x0)', durationMs: DURACAO_EVENTO_SIMPLES_MS, nectarMultiplier: 0, flowerMultiplier: 0.05, natalidadeMultiplier: 0, message: 'Temperaturas congelantes! As abelhas est√£o em estagna√ß√£o e a produ√ß√£o parou.', isCongelamento: true, travarAddBee: false, isCombatEvent: false, isCivilWar: false },
            'Temperatura Quente (Moderada)': { tipo: 'BOM', impacto: 'Mel (++), Natalidade (++), Flores (+)', durationMs: DURACAO_EVENTO_SIMPLES_MS, nectarMultiplier: 1.5, flowerMultiplier: 1.2, natalidadeMultiplier: 1.5, message: 'Temperatura agrad√°vel. A colheita de n√©ctar e a natalidade est√£o mais eficientes.', isCongelamento: false, travarAddBee: false, isCombatEvent: false, isCivilWar: false },
            
            // EVENTO DE INVAS√ÉO
            'Invas√£o de Abelhas Predadoras': { 
                tipo: 'RUIM', 
                impacto: `COMBATE: Lute at√© restar ${COMBAT_SURVIVAL_LIMIT_INVASION} abelhas amarelas.`, 
                durationMs: DURACAO_EVENTO_COMBATE_MS, 
                nectarMultiplier: 0.5, 
                flowerMultiplier: 0.8, 
                natalidadeMultiplier: 0.1, 
                message: 'Abelhas predadoras (Vermelhas) invadiram! Defenda a colmeia!', 
                isCongelamento: false, 
                travarAddBee: true, 
                isCombatEvent: true,
                isCivilWar: false, // N√ÉO √© Guerra Civil
                survivalCount: COMBAT_SURVIVAL_LIMIT_INVASION 
            },

            // EVENTO DA RAINHA: SAUD√ÅVEL
            'Rainha Saud√°vel (Prosperidade)': {
                tipo: 'ESPECIAL BOM', impacto: `Limite: ${MAX_BEES_HEALTHY}. B√¥nus de Flores/Abelhas.`, durationMs: DURACAO_EVENTO_RAINHA_MS,
                nectarMultiplier: 1.0, flowerMultiplier: 1.0, natalidadeMultiplier: 1.0, 
                message: 'Nova Rainha Saud√°vel (‚ù§Ô∏è)! Limite de abelhas aumentado e b√¥nus de produ√ß√£o!',
                isCongelamento: false, travarAddBee: false, isCombatEvent: false, isCivilWar: false
            },
            // EVENTO DA RAINHA: GUERRA CIVIL
            'Rainha N√£o Saud√°vel (Guerra Civil)': {
                tipo: 'ESPECIAL RUIM', 
                impacto: `GUERRA CIVIL: Lute at√© restar ${CIVIL_WAR_SURVIVAL_LIMIT} abelhas.`, 
                durationMs: DURACAO_EVENTO_COMBATE_MS, // Usa a mesma dura√ß√£o de combate (20 min)
                nectarMultiplier: 0.1, 
                flowerMultiplier: 0.5, 
                natalidadeMultiplier: 0.0, 
                message: 'Rainha Morta (üíÄ)! As abelhas entraram em Guerra Civil!',
                isCongelamento: false, 
                travarAddBee: true, 
                isCombatEvent: true, // √â um evento de combate
                isCivilWar: true, // √â uma Guerra Civil
                survivalCount: CIVIL_WAR_SURVIVAL_LIMIT 
            },
            // Adicionado o evento "Normal" para fins de sorteio
            'Normal': {
                 tipo: 'NEUTRO', impacto: 'Nenhum', durationMs: 0,
                 nectarMultiplier: 1.0, flowerMultiplier: 1.0, natalidadeMultiplier: 1.0, 
                 message: 'O ecossistema est√° est√°vel e em condi√ß√µes normais.',
                 isCongelamento: false, travarAddBee: false, isCombatEvent: false, isCivilWar: false
            }
        };

        // --- Fun√ß√µes de Cria√ß√£o e Status ---

        function updateHPBar(element, currentHp, maxHp) {
            const percentage = Math.max(0, (currentHp / maxHp) * 100);
            const hpBar = element.querySelector('.hp-bar');
            if (hpBar) {
                hpBar.style.width = `${percentage}%`;
            }
        }
        
        function criarHPBar(isInvader = false) {
            const container = document.createElement('div');
            container.className = 'hp-bar-container';
            const bar = document.createElement('div');
            bar.className = 'hp-bar';
            if (isInvader) {
                bar.classList.add('bg-red-500');
            } else {
                bar.classList.add('bg-green-500');
            }
            bar.style.width = '100%';
            container.appendChild(bar);
            return container;
        }


        function getRandomPosition() {
            const x = Math.random() * (ecossistema.clientWidth - 40) + 20;
            const y = Math.random() * (ecossistema.clientHeight - 40) + 20;
            return { x, y };
        }

        function criarFlor() {
             if (isAddingFlowerOnCooldown && !eventoAtivo || eventoAtivo && !eventoAtivo.isCivilWar && eventoAtivo.travarAddBee) return false;
             
            const pos = getRandomPosition();
            const florDiv = document.createElement('div');
            florDiv.className = 'flor';
            florDiv.style.left = `${pos.x}px`;
            florDiv.style.top = `${pos.y}px`;
            florDiv.dataset.nectar = 100;
            florDiv.dataset.id = florId++;
            
            florDiv.innerHTML = `<span class="nectar-value">${florDiv.dataset.nectar}</span>`;
            
            const tooltip = document.createElement('span');
            tooltip.className = 'flor-tooltip';
            tooltip.textContent = "N√©ctar: 100 | Ocupada: N√£o";
            florDiv.appendChild(tooltip);

            ecossistema.appendChild(florDiv);
            flores.push({ 
                element: florDiv, 
                x: pos.x, 
                y: pos.y, 
                nectar: parseInt(florDiv.dataset.nectar),
                occupiedByBeeId: null 
            });
            totalFloresDisplay.textContent = flores.length;

            florDiv.addEventListener('mouseover', () => {
                const occupiedStatus = flores.find(f => f.element === florDiv)?.occupiedByBeeId !== null ? 'Sim' : 'N√£o';
                const currentTooltip = florDiv.querySelector('.flor-tooltip');
                if (currentTooltip) {
                    currentTooltip.textContent = `N√©ctar: ${florDiv.dataset.nectar} | Ocupada: ${occupiedStatus}`;
                }
            });
            
            return true;
        }

        function criarAbelha(colmeiaTarget) {
            if (abelhas.length >= MAX_BEES) {
                console.log(`Limite m√°ximo de abelhas (${MAX_BEES}) atingido. N√£o √© poss√≠vel criar mais.`);
                return false; 
            }
            if (eventoAtivo && eventoAtivo.travarAddBee) {
                 console.log(`Bot√£o de Adicionar Abelha travado devido a ${eventoEmAndamento}.`);
                 return false;
            }
            
            const pos = getRandomPosition();
            const abelhaDiv = document.createElement('div');
            abelhaDiv.className = 'abelha bee-base'; 
            abelhaDiv.style.left = `${pos.x}px`;
            abelhaDiv.style.top = `${pos.y}px`;
            const currentBeeId = abelhaId++;
            abelhaDiv.dataset.id = currentBeeId;
            abelhaDiv.dataset.colmeiaTarget = colmeiaTarget || (currentBeeId % 2 === 0 ? 'colmeia1' : 'colmeia2');
            abelhaDiv.dataset.hasNectar = 'false';
            
            // Adiciona a barra de vida
            abelhaDiv.appendChild(criarHPBar(false));

            ecossistema.appendChild(abelhaDiv);
            
            abelhas.push({
                element: abelhaDiv,
                id: currentBeeId,
                x: pos.x,
                y: pos.y,
                targetFlor: null,
                targetBee: null, 
                hasNectar: false,
                hp: INITIAL_HP, 
                maxHp: INITIAL_HP,
                // Usa os novos limites de velocidade lenta
                speed: Math.random() * (BASE_SPEED_MAX - BASE_SPEED_MIN) + BASE_SPEED_MIN, 
                state: 'searching', 
                zigZagSeed: Math.random() * 2 * Math.PI,
                isEntering: false,
                lastAttackTime: 0 // Usado apenas na Guerra Civil
            });
            totalAbelhasDisplay.textContent = abelhas.length;
            return true; 
        }
        
        function criarAbelhaInvasora() {
             const pos = getRandomPosition();
            const abelhaDiv = document.createElement('div');
            abelhaDiv.className = 'abelha-invasora bee-base'; 
            abelhaDiv.style.left = `${pos.x}px`;
            abelhaDiv.style.top = `${pos.y}px`;
            const currentBeeId = abelhaId++; 
            abelhaDiv.dataset.id = currentBeeId;
            
            // Adiciona a barra de vida vermelha
            abelhaDiv.appendChild(criarHPBar(true));

            ecossistema.appendChild(abelhaDiv);
            
            abelhasInvasoras.push({
                element: abelhaDiv,
                id: currentBeeId,
                x: pos.x,
                y: pos.y,
                targetBee: null, 
                hp: INITIAL_HP, 
                maxHp: INITIAL_HP,
                // Invasoras um pouco mais r√°pidas
                speed: (Math.random() * (BASE_SPEED_MAX - BASE_SPEED_MIN) + BASE_SPEED_MIN) * 1.2, 
                state: 'fighting', 
                zigZagSeed: Math.random() * 2 * Math.PI,
                lastAttackTime: 0
            });
             totalAbelhasInvasorasDisplay.textContent = abelhasInvasoras.length;
        }

        const TEMPO_RENOVACAO = 6000;

        function iniciarTimerRemocao(florObj) {
            if (florObj.element.classList.contains('sem-nectar') && !florObj.element.dataset.removing) {
                florObj.element.dataset.removing = 'true';
                
                setTimeout(() => {
                    florObj.element.remove();

                    const idParaRemover = florObj.element.dataset.id;
                    const index = flores.findIndex(f => f.element.dataset.id === idParaRemover);
                    
                    if (index > -1) {
                        flores.splice(index, 1);
                        totalFloresDisplay.textContent = flores.length;
                    }

                }, TEMPO_RENOVACAO);
            }
        }

        function moverAbelha(abelha, targetX, targetY, currentSpeedFactor) {
            const currentSpeed = abelha.speed * currentSpeedFactor; 

            const dx = targetX - abelha.x;
            const dy = targetY - abelha.y;
            const distance = Math.sqrt(dx * dx + dy * dy);

            if (distance <= currentSpeed) {
                abelha.x = targetX;
                abelha.y = targetY;
                return true; 
            }

            const angleToTarget = Math.atan2(dy, dx);
            const oscillation = Math.sin(abelha.zigZagSeed) * 1.5; 
            abelha.zigZagSeed += 0.1; 
            const perpendicularAngle = angleToTarget + Math.PI / 2;

            const baseMoveX = Math.cos(angleToTarget) * currentSpeed;
            const baseMoveY = Math.sin(angleToTarget) * currentSpeed;

            const zigZagX = Math.cos(perpendicularAngle) * oscillation;
            const zigZagY = Math.sin(perpendicularAngle) * oscillation;
            
            abelha.x += baseMoveX + zigZagX;
            abelha.y += baseMoveY + zigZagY;

            abelha.element.style.left = `${abelha.x}px`;
            abelha.element.style.top = `${abelha.y}px`;
            return false;
        }
        
        function sortearEvento() {
             resetarEvento();
             
             // =======================================================
             // ALTERA√á√ÉO SOLICITADA: GARANTIR SORTEIO 100% ALEAT√ìRIO ENTRE TODOS OS EVENTOS (INCLUINDO 'Normal')
             // =======================================================
             const eventKeys = Object.keys(EVENTOS).filter(key => 
                  !key.includes('Rainha') // Mantenha a exclus√£o dos eventos da Rainha do sorteio di√°rio (eles t√™m seu pr√≥prio agendamento no Dia 10)
             );

             const randomKey = eventKeys[Math.floor(Math.random() * eventKeys.length)];
             
             if (randomKey === 'Normal') {
                 // Aplica as propriedades do evento "Normal" (que √© um reset)
                 eventoEmAndamento = 'Normal';
                 statusEventoDisplay.textContent = 'Normal';
                 impactoEventoDisplay.textContent = 'Nenhum';
                 // N√£o chama aplicarImpactoEvento, pois Normal j√° √© o estado base
             } else {
                 aplicarImpactoEvento(randomKey);
             }
        }

        // --- Fun√ß√µes de Alerta e Timer ---
        function mostrarAlertaFlutuante(titulo, mensagem) {
            alertTitle.textContent = titulo;
            alertMessage.textContent = mensagem;
            floatingAlert.style.display = 'block';
            
            setTimeout(() => {
                floatingAlert.style.display = 'none';
            }, 10000); 
        }
        
        function iniciarCronometro(durationMs) {
            if (countdownInterval) clearInterval(countdownInterval);
            
            let timeLeft = Math.ceil(durationMs / 1000);
            
            const updateTimer = () => {
                const minutes = String(Math.floor(timeLeft / 60)).padStart(2, '0');
                const seconds = String(timeLeft % 60).padStart(2, '0');
                eventTimerDisplay.textContent = `${minutes}:${seconds}`;
                
                if (timeLeft <= 0) {
                    clearInterval(countdownInterval);
                    eventTimerDisplay.textContent = 'FIM';
                }
                timeLeft--;
            };
            
            updateTimer(); 
            countdownInterval = setInterval(updateTimer, 1000);
        }

        // --- NOVO: L√≥gica de Combate ---
        
        function iniciarEventoGuerraCivil(eventoKey) {
            const evento = EVENTOS[eventoKey];
            
            // 1. Condi√ß√£o de Cancelamento Obrigat√≥ria (Regra: <= 2 abelhas)
            if (abelhas.length <= CIVIL_WAR_SURVIVAL_LIMIT) {
                 const message = `Iria ocorrer um evento de Guerra Civil, mas devido ao baixo n√∫mero de abelhas (limite de ${CIVIL_WAR_SURVIVAL_LIMIT} atingido), ele foi cancelado.`;
                 mostrarAlertaFlutuante("Evento Cancelado", message);
                 
                 eventoEmAndamento = 'Normal';
                 statusEventoDisplay.textContent = 'Normal';
                 impactoEventoDisplay.textContent = 'Nenhum';
                 return; 
            }

            // 2. Aplica√ß√£o do Impacto
            eventoAtivo = evento;
            tempoFimEvento = performance.now() + evento.durationMs; 
            eventoEmAndamento = eventoKey;
            statusEventoDisplay.textContent = eventoKey; 
            impactoEventoDisplay.textContent = evento.impacto;

            mostrarAlertaFlutuante(eventoKey, evento.message);
            iniciarCronometro(evento.durationMs);

            adicionarAbelhaBtn.disabled = true;
            adicionarAbelhaBtn.textContent = 'Abelha (Travado)';
            
            // Adiciona a classe de Guerra Civil
            abelhas.forEach(bee => bee.element.classList.add('em-guerra'));
        }

        function iniciarEventoInvasao(eventoKey) {
            const evento = EVENTOS[eventoKey];
            
            // 1. Condi√ß√£o de Cancelamento Obrigat√≥ria (Regra: <= 3 abelhas)
            if (abelhas.length <= COMBAT_SURVIVAL_LIMIT_INVASION) {
                 const message = `O evento de invas√£o iria ocorrer, no entanto, o limite de abelhas permitido √© de apenas ${COMBAT_SURVIVAL_LIMIT_INVASION}, por isso ele foi cancelado.`;
                 mostrarAlertaFlutuante("Evento Cancelado", message);
                 
                 eventoEmAndamento = 'Normal';
                 statusEventoDisplay.textContent = 'Normal';
                 impactoEventoDisplay.textContent = 'Nenhum';
                 return; 
            }

            // 2. Aplica√ß√£o do Impacto
            eventoAtivo = evento;
            tempoFimEvento = performance.now() + evento.durationMs; 
            eventoEmAndamento = eventoKey;
            statusEventoDisplay.textContent = eventoKey; 
            impactoEventoDisplay.textContent = evento.impacto;

            mostrarAlertaFlutuante(eventoKey, evento.message);
            iniciarCronometro(evento.durationMs);

            adicionarAbelhaBtn.disabled = true;
            adicionarAbelhaBtn.textContent = 'Abelha (Travado)';
            
            // 3. Cria√ß√£o dos Invasores (Invasores = Abelhas Amarelas - Limite de Sobreviv√™ncia)
            const invadersToCreate = abelhas.length - COMBAT_SURVIVAL_LIMIT_INVASION;
            for(let i = 0; i < Math.max(2, invadersToCreate); i++) { // Garante no m√≠nimo 2 invasores
                criarAbelhaInvasora();
            }
        }


        function aplicarImpactoEvento(eventoKey) {
            const evento = EVENTOS[eventoKey];
            
            if (evento.isCombatEvent) {
                if (evento.isCivilWar) {
                    iniciarEventoGuerraCivil(eventoKey);
                } else {
                    iniciarEventoInvasao(eventoKey);
                }
                return;
            }

            eventoAtivo = evento;
            tempoFimEvento = performance.now() + evento.durationMs; 
            
            eventoEmAndamento = eventoKey;
            statusEventoDisplay.textContent = eventoKey; 
            impactoEventoDisplay.textContent = evento.impacto;

            mostrarAlertaFlutuante(eventoKey, evento.message);
            iniciarCronometro(evento.durationMs);

            GAME_SPEED_FACTOR = evento.isCongelamento ? 0.05 : 1.0; 
            
            if (evento.travarAddBee) {
                adicionarAbelhaBtn.disabled = true;
                adicionarAbelhaBtn.textContent = 'Abelha (Travado)';
            }
        }
        
        function resetarEvento() {
            if (countdownInterval) clearInterval(countdownInterval);
            eventTimerDisplay.textContent = '--'; 

            eventoAtivo = null;
            tempoFimEvento = 0;
            GAME_SPEED_FACTOR = 1.0; 
            floatingAlert.style.display = 'none'; 
            
            // Limpa Invasoras (Se sobraram no final)
            abelhasInvasoras.forEach(inv => inv.element.remove());
            abelhasInvasoras = [];

            // Remove a classe de Guerra Civil
            abelhas.forEach(bee => bee.element.classList.remove('em-guerra'));

            // Resetar Limite de Abelhas 
            if (rainha1Saude === 'Saud√°vel' || rainha2Saude === 'Saud√°vel') {
                 MAX_BEES = MAX_BEES_HEALTHY;
            } else {
                 MAX_BEES = 50; 
            }
            maxAbelhasDisplay.textContent = MAX_BEES;
            
            // Destravar bot√£o de adicionar abelha
            adicionarAbelhaBtn.disabled = false;
            adicionarAbelhaBtn.textContent = 'Adicionar Abelha'; 
            
            // Resetar display
            eventoEmAndamento = 'Normal';
            statusEventoDisplay.textContent = 'Normal';
            impactoEventoDisplay.textContent = 'Nenhum';
            
            totalAbelhasInvasorasDisplay.textContent = abelhasInvasoras.length;
        }
        
        // --- EVENTO: NOVA RAINHA ---
        function iniciarEventoNovaRainha() {
            const isHealthy = Math.random() < 0.5;
            
            // Define o status da Rainha
            rainha1Saude = 'Normal'; 
            rainha2Saude = 'Normal';

            rainha1StatusDisplay.textContent = isHealthy ? '‚ù§Ô∏è' : 'üíÄ';
            rainha2StatusDisplay.textContent = isHealthy ? '‚ù§Ô∏è' : 'üíÄ';

            let eventoKey;

            if (isHealthy) {
                eventoKey = 'Rainha Saud√°vel (Prosperidade)';
                aplicarImpactoEvento(eventoKey);

                MAX_BEES = MAX_BEES_HEALTHY;
                maxAbelhasDisplay.textContent = MAX_BEES;
                
                // B√¥nus
                for (let i = 0; i < 5; i++) {
                    criarAbelha();
                    criarFlor();
                }
                
                adicionarAbelhaBtn.disabled = false;
                adicionarAbelhaBtn.textContent = 'Adicionar Abelha'; 
                isAddingBeeOnCooldown = false;
                isAddingFlowerOnCooldown = false;

            } else {
                eventoKey = 'Rainha N√£o Saud√°vel (Guerra Civil)';
                iniciarEventoGuerraCivil(eventoKey); // Chama a fun√ß√£o espec√≠fica com a l√≥gica de cancelamento
            }
            
            // O reset para a Rainha n√£o Saud√°vel ocorrer√° dentro da simular() quando o combate terminar.
            if (isHealthy) {
                 setTimeout(() => {
                    rainha1StatusDisplay.textContent = '';
                    rainha2StatusDisplay.textContent = '';
                    rainha1Saude = 'Normal';
                    rainha2Saude = 'Normal';
                    resetarEvento(); 
                 }, DURACAO_EVENTO_RAINHA_MS);
            }
        }

        
        // --- Fun√ß√£o Auxiliar para Coordenadas da Colmeia ---
        function getColmeiaCoords(colmeiaId) {
            const targetColmeiaElement = document.getElementById(colmeiaId);
            const colmeiaRect = targetColmeiaElement.getBoundingClientRect();
            const ecoRect = ecossistema.getBoundingClientRect();
            
            const colmeiaX = colmeiaRect.left + colmeiaRect.width / 2 - ecoRect.left;
            const colmeiaY = colmeiaRect.top + colmeiaRect.height / 2 - ecoRect.top;
            return { colmeiaX, colmeiaY };
        }

        // L√≥gica principal da simula√ß√£o
        function simular(timestamp) {
            if (!simulacaoAtiva) {
                // Se a simula√ß√£o for pausada, apenas atualiza o lastTimestamp e retorna para o requestAnimationFrame n√£o ser chamado
                lastTimestamp = timestamp; 
                return; // N√ÉO CHAMAR requestAnimationFrame(simular)
            }

            // Se a simula√ß√£o estiver ativa, chama o requestAnimationFrame para o pr√≥ximo frame
            animationFrameId = requestAnimationFrame(simular);

            const deltaTime = timestamp - lastTimestamp;
            lastTimestamp = timestamp;

            // --- L√≥gica de Progress√£o do Tempo do Dia e Eventos ---
            tempoDecorridoDia += deltaTime;

            if (tempoDecorridoDia >= MILISSEGUNDOS_POR_DIA) {
                diaJogo++;
                tempoDecorridoDia = 0;
                diaJogoDisplay.textContent = diaJogo;
                
                if (diaJogo % 10 === 0) {
                    iniciarEventoNovaRainha();
                } else {
                    sortearEvento(); 
                }
            }
            
            // --- Controle de Fim de Evento (Geral) ---
            if (eventoAtivo && timestamp > tempoFimEvento && !eventoAtivo.isCombatEvent) {
                console.log(`Fim do evento: ${eventoEmAndamento}. Resetando para Normal.`);
                resetarEvento();
            }

            // --- L√≥gica de COMBATE (Se Ativo) ---
            if (eventoAtivo && eventoAtivo.isCombatEvent) {
                
                const isCivilWar = eventoAtivo.isCivilWar;
                const survivalLimit = eventoAtivo.survivalCount;

                // 1. CHECAGEM DE FIM DE COMBATE
                if (abelhas.length <= survivalLimit) {
                    const title = isCivilWar ? "Fim da Guerra Civil (Limite Atingido)" : "Vit√≥ria (Pyrrhic)!";
                    const message = isCivilWar 
                        ? `A Guerra Civil terminou! Limite de ${survivalLimit} abelhas atingido. Restaram ${abelhas.length} abelhas.`
                        : `A invas√£o terminou! Limite de ${survivalLimit} abelhas atingido. Restaram ${abelhas.length} abelhas.`;
                    mostrarAlertaFlutuante(title, message);
                    resetarEvento();
                    return;
                }
                
                if (performance.now() > tempoFimEvento) {
                    const title = isCivilWar ? "Guerra Civil (Tempo Esgotado)" : "Invas√£o (Tempo Esgotado)";
                    const message = isCivilWar 
                         ? `A Guerra Civil terminou por limite de tempo. Restaram ${abelhas.length} abelhas.`
                         : `A invas√£o terminou por limite de tempo. Restaram ${abelhas.length} abelhas.`;
                    mostrarAlertaFlutuante(title, message);
                    resetarEvento();
                    return;
                }

                // 2. L√ìGICA DE ATAQUE E MOVIMENTO
                if (timestamp - lastAttackTimestamp > ATTACK_RATE) {
                    
                    if (isCivilWar) {
                        // GUERRA CIVIL: Abelhas Amarelas brigam entre si
                        abelhas.forEach(bee => {
                            // 2a. Busca/Atribui√ß√£o de Alvo (Outra Abelha Amarela)
                            if (!bee.targetBee || bee.targetBee.hp <= 0 || bee.targetBee === bee) {
                                 // Filtra outras abelhas com HP > 0
                                 const potentialTargets = abelhas.filter(a => a.id !== bee.id && a.hp > 0); 
                                 bee.targetBee = potentialTargets.length > 0 ? potentialTargets[Math.floor(Math.random() * potentialTargets.length)] : null;
                            }

                            // 2b. Ataque e Movimento
                            if (bee.targetBee) {
                                const target = bee.targetBee;
                                if (moverAbelha(bee, target.x, target.y, GAME_SPEED_FACTOR)) {
                                    // Causa dano e atualiza a barra do alvo
                                    target.hp = Math.max(0, target.hp - ATTACK_DAMAGE);
                                    updateHPBar(target.element, target.hp, target.maxHp);
                                }
                            }
                        });
                        // Nenhuma invasora est√° envolvida.
                        
                    } else {
                        // INVAS√ÉO PREDADORA: Abelhas Amarelas vs. Invasoras Vermelhas
                        
                        // Turno das Abelhas Amarelas (Alvo: Invasoras)
                        abelhas.forEach(bee => {
                             if (!bee.targetBee || bee.targetBee.hp <= 0 || !abelhasInvasoras.some(inv => inv.id === bee.targetBee.id)) {
                                 bee.targetBee = abelhasInvasoras.length > 0 ? abelhasInvasoras[Math.floor(Math.random() * abelhasInvasoras.length)] : null;
                             }

                             if (bee.targetBee) {
                                 const target = bee.targetBee;
                                 if (moverAbelha(bee, target.x, target.y, GAME_SPEED_FACTOR)) {
                                     target.hp = Math.max(0, target.hp - ATTACK_DAMAGE);
                                     updateHPBar(target.element, target.hp, target.maxHp);
                                 }
                             }
                        });

                        // Turno das Abelhas Invasoras (Alvo: Abelhas Amarelas)
                        abelhasInvasoras.forEach(inv => {
                             if (!inv.targetBee || inv.targetBee.hp <= 0 || !abelhas.some(a => a.id === inv.targetBee.id)) {
                                 inv.targetBee = abelhas.length > 0 ? abelhas[Math.floor(Math.random() * abelhas.length)] : null;
                             }

                            if (inv.targetBee) {
                                const target = inv.targetBee;
                                if (moverAbelha(inv, target.x, target.y, GAME_SPEED_FACTOR)) {
                                    target.hp = Math.max(0, target.hp - ATTACK_DAMAGE);
                                    updateHPBar(target.element, target.hp, target.maxHp);
                                }
                            }
                        });
                    }
                    
                    lastAttackTimestamp = timestamp; 

                    // 3. Limpeza (Remo√ß√£o dos mortos)
                    const checkDeath = (list) => {
                        for (let i = list.length - 1; i >= 0; i--) {
                            const bee = list[i];
                            if (bee.hp <= 0) {
                                bee.element.remove();
                                list.splice(i, 1);
                            }
                        }
                    };
                    
                    checkDeath(abelhas);
                    if (!isCivilWar) { 
                        checkDeath(abelhasInvasoras);
                    }
                }

                return; // Pula a l√≥gica de coleta
            }
            // --- FIM L√≥gica de COMBATE ---


            // --- L√≥gica de Coleta e Movimento das Abelhas (Normal) ---
            const nectarMult = eventoAtivo ? eventoAtivo.nectarMultiplier : 1.0;
            
            abelhas.forEach(abelha => {
                
                if (abelha.isEntering) return;
                
                const { colmeiaX, colmeiaY } = getColmeiaCoords(abelha.element.dataset.colmeiaTarget);
                
                // Estados de Espera/Retorno/Busca (L√≥gica de movimento normal)
                
                if (abelha.state === 'waiting') {
                    // L√≥gica de espera... (inalterada)
                    const availableFlower = flores.find(f => f.nectar > 0 && f.occupiedByBeeId === null);
                    
                    if (availableFlower) {
                        abelha.targetFlor = availableFlower;
                        availableFlower.occupiedByBeeId = abelha.id; 
                        availableFlower.element.classList.add('ocupada');
                        abelha.state = 'collecting';
                    } else {
                        const waitX = colmeiaX + Math.sin(abelha.zigZagSeed * 0.2) * 15;
                        const waitY = colmeiaY + Math.cos(abelha.zigZagSeed * 0.2) * 15;
                        moverAbelha(abelha, waitX, waitY, GAME_SPEED_FACTOR); 
                        return;
                    }
                }

                if (abelha.hasNectar || abelha.state === 'returning_to_wait') {
                    // L√≥gica de retorno √† colmeia... (inalterada)
                    if (moverAbelha(abelha, colmeiaX, colmeiaY, GAME_SPEED_FACTOR)) {
                        
                        abelha.isEntering = true;
                        abelha.element.classList.add('entering-hive'); 

                        setTimeout(() => {
                            abelha.isEntering = false;
                            abelha.element.classList.remove('entering-hive');
                            
                            const offset = Math.random() * 20 - 10; 
                            abelha.x = colmeiaX + offset;
                            abelha.y = colmeiaY + offset;
                            abelha.element.style.left = `${abelha.x}px`;
                            abelha.element.style.top = `${abelha.y}px`;


                            if (abelha.hasNectar) {
                                abelha.hasNectar = false;
                                abelha.element.classList.remove('com-nectar');
                                
                                const melProduzido = TAXA_PRODUCAO_MEL_BASE * nectarMult; 
                                
                                if (abelha.element.dataset.colmeiaTarget === 'colmeia1') {
                                    melColmeia1 += melProduzido;
                                    document.getElementById('colmeia1').querySelector('.mel-produzido').textContent = `Mel: ${Math.floor(melColmeia1)}`;
                                    melColmeia1Display.textContent = Math.floor(melColmeia1);
                                } else {
                                    melColmeia2 += melProduzido;
                                    document.getElementById('colmeia2').querySelector('.mel-produzido').textContent = `Mel: ${Math.floor(melColmeia2)}`;
                                    melColmeia2Display.textContent = Math.floor(melColmeia2);
                                }
                                
                                abelha.state = 'searching'; 
                            } else if (abelha.state === 'returning_to_wait') {
                                abelha.state = 'waiting'; 
                            }
                            abelha.targetFlor = null;

                        }, HIVE_ENTRY_TIME); 
                    }
                    return;
                } 
                
                if (abelha.state === 'searching' || abelha.state === 'collecting') {
                    
                    // L√≥gica de busca e coleta... (inalterada)
                    
                    if (abelha.targetFlor && (abelha.targetFlor.nectar <= 0 || (abelha.targetFlor.occupiedByBeeId !== abelha.id && abelha.targetFlor.occupiedByBeeId !== null))) {
                        if (abelha.targetFlor.occupiedByBeeId === abelha.id) {
                            abelha.targetFlor.occupiedByBeeId = null; 
                            abelha.targetFlor.element.classList.remove('ocupada');
                        }
                        abelha.targetFlor = null; 
                        abelha.state = 'searching';
                    }

                    if (!abelha.targetFlor) {
                        let closestFlor = null;
                        let minDistance = Infinity;

                        const availableFlores = flores.filter(f => f.nectar > 0 && f.occupiedByBeeId === null);

                        if (availableFlores.length > 0) {
                            availableFlores.forEach(flor => {
                                const distance = Math.sqrt(Math.pow(flor.x - abelha.x, 2) + Math.pow(flor.y - abelha.y, 2));
                                if (distance < minDistance) {
                                    minDistance = distance;
                                    closestFlor = flor;
                                }
                            });

                            if (closestFlor) {
                                abelha.targetFlor = closestFlor;
                                closestFlor.occupiedByBeeId = abelha.id; 
                                closestFlor.element.classList.add('ocupada');
                                abelha.state = 'collecting';
                            }
                        } else {
                            abelha.state = 'returning_to_wait';
                            return;
                        }
                    }

                    if (abelha.targetFlor && abelha.state === 'collecting') {
                        if (moverAbelha(abelha, abelha.targetFlor.x, abelha.targetFlor.y, GAME_SPEED_FACTOR)) {
                            if (abelha.targetFlor.nectar > 0) {
                                abelha.targetFlor.nectar -= 10;
                                abelha.targetFlor.element.dataset.nectar = abelha.targetFlor.nectar;
                                
                                abelha.targetFlor.element.querySelector('.nectar-value').textContent = abelha.targetFlor.nectar;
                                
                                abelha.hasNectar = true;
                                abelha.element.classList.add('com-nectar');
                                
                                abelha.targetFlor.occupiedByBeeId = null; 
                                abelha.targetFlor.element.classList.remove('ocupada');

                                abelha.state = 'returning'; 
                            
                                if (abelha.targetFlor.nectar <= 0) {
                                    abelha.targetFlor.element.classList.add('sem-nectar');
                                    iniciarTimerRemocao(abelha.targetFlor);
                                }
                            } else {
                                abelha.targetFlor.occupiedByBeeId = null; 
                                abelha.targetFlor.element.classList.remove('ocupada');
                                abelha.targetFlor = null;
                                abelha.state = 'searching'; 
                            }
                        }
                    }
                }
            });
            
            // --- Atualiza√ß√£o dos Displays ---
            totalAbelhasDisplay.textContent = abelhas.length;

            // Se a simula√ß√£o estiver ativa, a chamada do requestAnimationFrame j√° foi feita no in√≠cio da fun√ß√£o
        }

        // --- Inicializa√ß√£o e Listeners ---
        iniciarBtn.addEventListener('click', () => {
            if (!simulacaoIniciada) {
                // PRIMEIRO IN√çCIO
                simulacaoIniciada = true;
                simulacaoAtiva = true;
                iniciarBtn.textContent = 'Pausar Simula√ß√£o';
                iniciarBtn.classList.remove('bg-green-500', 'hover:bg-green-600');
                iniciarBtn.classList.add('bg-orange-500', 'hover:bg-orange-600');

                // CRIA√á√ÉO INICIAL
                for (let i = 0; i < 5; i++) { 
                    criarFlor(); 
                }
                for (let i = 0; i < 2; i++) { 
                    criarAbelha(i === 0 ? 'colmeia1' : 'colmeia2'); 
                }

                // Inicia o loop
                animationFrameId = requestAnimationFrame(simular);

            } else if (simulacaoAtiva) {
                // PAUSAR
                simulacaoAtiva = false;
                cancelAnimationFrame(animationFrameId); // Para o loop
                iniciarBtn.textContent = 'Continuar Simula√ß√£o';
                iniciarBtn.classList.remove('bg-orange-500', 'hover:bg-orange-600');
                iniciarBtn.classList.add('bg-blue-500', 'hover:bg-blue-600');

            } else {
                // CONTINUAR
                simulacaoAtiva = true;
                iniciarBtn.textContent = 'Pausar Simula√ß√£o';
                iniciarBtn.classList.remove('bg-blue-500', 'hover:bg-blue-600');
                iniciarBtn.classList.add('bg-orange-500', 'hover:bg-orange-600');
                
                // Reinicia o loop. O `simular` ir√° chamar requestAnimationFrame novamente
                animationFrameId = requestAnimationFrame(simular);
            }
        });

        // =======================================================
        // L√ìGICA DE COOLDOWN (Mantida da solicita√ß√£o anterior)
        // =======================================================

        adicionarFlorBtn.addEventListener('click', () => {
            if (isAddingFlowerOnCooldown) return;
            if (criarFlor()) {
                isAddingFlowerOnCooldown = true;
                
                // Desabilita o bot√£o e muda o texto
                adicionarFlorBtn.disabled = true;
                adicionarFlorBtn.textContent = 'Flor (3s)';

                let countdown = 3;
                adicionarFlorBtn.textContent = `Flor (${countdown}s)`;
                
                const timer = setInterval(() => {
                    countdown--;
                    if (countdown > 0) {
                        adicionarFlorBtn.textContent = `Flor (${countdown}s)`;
                    } else {
                        clearInterval(timer);
                        isAddingFlowerOnCooldown = false;
                        adicionarFlorBtn.disabled = false;
                        adicionarFlorBtn.textContent = 'Adicionar Flor';
                    }
                }, 1000);
                
            }
        });

        adicionarAbelhaBtn.addEventListener('click', () => {
            // Se j√° estiver em cooldown ou em evento que trava, retorna
            if (isAddingBeeOnCooldown || (eventoAtivo && eventoAtivo.travarAddBee)) return;
            
            if (criarAbelha()) {
                isAddingBeeOnCooldown = true;
                
                // Desabilita o bot√£o e muda o texto
                adicionarAbelhaBtn.disabled = true;
                adicionarAbelhaBtn.textContent = 'Abelha (3s)';

                let countdown = 3;
                adicionarAbelhaBtn.textContent = `Abelha (${countdown}s)`;

                const timer = setInterval(() => {
                    countdown--;
                    if (countdown > 0) {
                        adicionarAbelhaBtn.textContent = `Abelha (${countdown}s)`;
                    } else {
                        clearInterval(timer);
                        isAddingBeeOnCooldown = false;
                        adicionarAbelhaBtn.disabled = false;
                        adicionarAbelhaBtn.textContent = 'Adicionar Abelha';
                    }
                }, 1000);
            }
        });
        
        // Inicializa o contador de abelhas
        totalAbelhasDisplay.textContent = abelhas.length;
        maxAbelhasDisplay.textContent = MAX_BEES;
        
    });
</script>
</body>
</html>